<link rel="import" href="../polymer/polymer.html">
<script src="./Sortable-polymer.js"></script>

<dom-module id="sortable-js">
  <template>
    <content></content>
  </template>
  <script>
    Polymer({
      is: "sortable-js",

      properties: {
        group             : { type: Object, value: function() { return Math.random() }, notify: true },
        sort              : { type: Object, value: true, notify: true},
        delay             : { type: Number, value: 0, notify: true },
        disabled          : { type: Boolean, value: false, notify: true},
        store             : { type: Object, value: null, notify: true },
        animation         : { type: Number, value: 0, notify: true },
        handle            : { type: String, value: null, notify: true },
        filter            : { type: Object, value: null, notify: true },
        draggable         : { type: String, value: ">*", notify: true },
        ghostClass        : { type: String, value: "sortable-ghost", notify: true },
        chosenClass       : { type: String, value: "sortable-chosen", notify: true },
        ignore            : { type: String, value: "a, img", notify: true },
        dropBubble        : { type: Boolean, value: false, notify: true },
        dragoverBubble    : { type: Boolean, value: false, notify: true }
        dataIdAttr        : { type: String, value: "data-id", notify: true },

        forceFallback     : { type: Boolean, value: false, notify: true },
        fallbackClass     : { type: String, value: "sortable-fallback", notify: true },
        fallbackOnBody    : { type: Boolean, value: false, notify: true },
        fallbackTolerance : { type: Number, value: 0, notify: true },

        scroll            : { type: Object, value: true, notify: true },
        scrollSensitivity : { type: Number, value: 30, notify: true },
        scrollSpeed       : { type: Number, value: 10, notify: true },

      },
      created: function() {
        /* watch all properties with notify = true */
        Object.keys(this.properties).forEach(function(key) {
          this.addEventListener(key+'-changed', function(e){
            this.sortable && this.sortable.option(key, e.detail.value);
          });
        });
      },
      attached: function() {
        // Given
        //   <sortable-js>
        //     <template is="dom-repeat" items={{data}}>
        //       <div>
        //         <template is="dom-if" if="true">
        //           <span>hello</span></template></div>
        // After render, it becomes
        //   <sortable-js>
        //     <div>
        //       <span>hello</span>
        //       <template is="dom-if">
        //     <template is="dom-repeat">

        var templates = this.querySelectorAll("template[is='dom-repeat']")
        var template = templates[templates.length-1]
        var options = {}, _this = this;

        Object.keys(this.properties).forEach(function(key) {
          options[key] = _this[key]
        });

        this.sortable = Sortable.create(this, Object.assign(options, {
          onUpdate: function (e) {
            if (template) {
              template.splice("items", e.newIndex, 0, template.splice("items", e.oldIndex, 1)[0])
            }
            _this.fire("update", e)
          },

          onAdd: function(e) {
            if (template) {
              var froms = e.from.querySelectorAll("template[is='dom-repeat']")
              var from = froms[froms.length-1]
              var item = from.items[e.oldIndex]
              template.splice("items", e.newIndex, 0, item)
            }
            _this.fire("add", e)
          },

          onRemove: function(e) {
            if (template) {
              template.splice("items", e.oldIndex, 1)[0]
            }
            _this.fire("remove", e)
          },

          onChoose: function(e) {
            _this.fire("choose", e)
          },

          onStart: function(e) {
            _this.fire("start", e)
          },

          onEnd: function(e) {
            _this.fire("end", e)
          },

          onSort: function(e) {
            _this.fire("sort", e)
          },

          onFilter: function(e) {
            _this.fire("filter", e)
          },

          onMove: function(e) {
            _this.fire("move", e)
          },

          onClone: function(e) {
            _this.fire("clone", e)
          }
        }));
      },

      detached: function() {
        this.sortable.destroy();
      }

    })
  </script>
</dom-module>
